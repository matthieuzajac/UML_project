@startuml sequence diagram subscription
header Diagramme de Séquence - Abonnement à un Roman
actor "Reader/Author" as R
participant "UI : NovelPage" as UI
participant "sub : Subscription" as SUB
participant "novel : Novel" as N
participant "notif : NotificationService" as NS
database "Database" as DB

note right of R
  Un Author peut aussi s'abonner
  à d'autres romans en tant que Reader
end note

== Subscribe to Novel ==
R -> UI : click "Subscribe"
UI -> SUB : subscribe(readerId, novelId)
activate SUB

SUB -> DB : checkExistingSubscription(readerId, novelId)
activate DB
DB --> SUB : notExists
deactivate DB

SUB -> DB : createSubscription(readerId, novelId)
activate DB
DB --> SUB : success
deactivate DB

SUB -> N : incrementFollowerCount()
activate N
N -> DB : updateFollowerCount()
activate DB
DB --> N : success
deactivate DB
deactivate N

SUB --> UI : subscribed
deactivate SUB
UI --> R : show "Subscribed! You'll receive notifications"

== New Chapter Notification ==
participant "author : Author" as A

A -> N : publishChapter(chapterData)
activate N

N -> DB : saveChapter(chapterData)
activate DB
DB --> N : success
deactivate DB

N -> NS : notifySubscribers(novelId, chapterTitle)
activate NS

NS -> DB : getSubscribers(novelId, notify_on_update=true)
activate DB
DB --> NS : subscriberList
deactivate DB

loop for each subscriber
    NS -> NS : createNotification(subscriberId, message, type=NEW_CHAPTER)
    NS -> DB : saveNotification()
    activate DB
    DB --> NS : success
    deactivate DB
    
    NS -> NS : sendEmail(subscriberEmail, message)
end

NS --> N : allNotificationsSent
deactivate NS

N --> A : chapterPublished
deactivate N

== Unsubscribe ==
R -> UI : click "Unsubscribe"
UI -> SUB : unsubscribe(readerId, novelId)
activate SUB

SUB -> DB : deleteSubscription(readerId, novelId)
activate DB
DB --> SUB : success
deactivate DB

SUB -> N : decrementFollowerCount()
activate N
N -> DB : updateFollowerCount()
activate DB
DB --> N : success
deactivate DB
deactivate N

SUB --> UI : unsubscribed
deactivate SUB
UI --> R : show "Unsubscribed"

@enduml
